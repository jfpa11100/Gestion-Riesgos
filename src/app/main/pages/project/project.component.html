<app-header [loading]="loading" [title]="project()?.name!" (toggleSideBar)="isSideBarOpen = $event" />

<main class="flex h-full pb-15">
  <app-side-menu [open]="isSideBarOpen" />

  <section class="flex flex-col w-full">

    @if (loading){
    <ngx-skeleton-loader class="flex w-full justify-center sm:pr-0 mt-[1lh]" count="1" appearance="square"
      animation="progress" [theme]="{
          width: '70%',
          height: '80px',
          background: 'lightgray',
          'border-radius': '5px',
          'margin': '0 auto'
        }" />

    <ngx-skeleton-loader class="w-full flex flex-col justify-center gap-y-2 pr-[1lh] sm:pr-0 mt-[2lh]" count="3"
      appearance="square" animation="progress" [theme]="{
          width: 'calc(8/10 * 100%)',
          height: 'calc(var(--spacing) * 10)',
          background: 'lightgray',
          'border-radius': '5px',
          'margin': '0 auto'
        }" />
    }@else{
    <section class="mt-[1lh] w-full flex flex-col justify-center items-center gap-y-0">
      <div class="flex flex-col self-center w-7/10 p-1 min-h-25 max-h-40 text-base scroll-smooth overflow-y-auto">
        <span class="block text-xl">Descripción:</span>
        {{ project()?.description }}
      </div>
      <div class="flex self-center justify-between w-full md:w-8/10 my-2">
        <button class="btn-secondary text-sm flex items-center py-1 pl-4 pr-3 gap-x-1" (click)="createSprint()">
          Crear Sprint
          <svg class="size-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="none" viewBox="0 0 24 26">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/>
          </svg>
        </button>

         <div class="flex gap-x-[1lh] items-center">
           <button class="btn-primary text-sm flex items-center py-1 px-3 gap-x-2" (click)="goToPrioritizationList(sortedSprints()[openSprintIndex-1])">
             <svg class="size-6 text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
              <path fill-rule="evenodd" d="M8 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1h2a2 2 0 0 1 2 2v15a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h2Zm6 1h-4v2H9a1 1 0 0 0 0 2h6a1 1 0 1 0 0-2h-1V4Zm-3 8a1 1 0 0 1 1-1h3a1 1 0 1 1 0 2h-3a1 1 0 0 1-1-1Zm-2-1a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2H9Zm2 5a1 1 0 0 1 1-1h3a1 1 0 1 1 0 2h-3a1 1 0 0 1-1-1Zm-2-1a1 1 0 1 0 0 2h.01a1 1 0 1 0 0-2H9Z" clip-rule="evenodd"/>
            </svg>
             Listado Priorización
           </button>
           <button class="btn-primary text-sm flex items-center py-1 px-4 border border-complementary-purple hover:border-complementary-blue" (click)="goToPrioritizationMatrix(sortedSprints()[openSprintIndex-1])">
             <img class="size-6 mr-2" src="grid.png" alt="">
             Matriz Priorización
           </button>
         </div>
      </div>

      @for (sprint of sortedSprints(); track $index) {
      <section class="flex flex-col w-8/10 mb-2">
        <div (click)="(openSprintIndex === sprint.sprint ? openSprintIndex=0 : openSprintIndex=sprint.sprint)"
          class="flex items-center justify-between w-full cursor-pointer border border-secondary-blue p-4 rounded">
          <div class="flex items-center gap-x-3">
            <h2 class="text-sm text-main-black/90">Sprint {{ sprint.sprint }} </h2>
            @if (sprint.mitigation_date) {
              <span class="text-xs text-secondary-blue">{{ sprint.mitigation_date | date:'medium' }}</span>
            }@else {
              <button (click)="$event.stopPropagation()" (click)="openDatepicker = {show: true, sprint:sprint}" class="z-10 p-1 flex items-center w-fit gap-x-1 rounded hover:cursor-pointer hover:bg-white-letter hover:text-white hover:border-complementary-purple">
                <svg class="size-3" fill="none" viewBox="0 0 16 16" role="presentation">
                  <path fill="currentcolor" fill-rule="evenodd" d="M11.586.854a2 2 0 0 1 2.828 0l.732.732a2 2 0 0 1 0 2.828L10.01 9.551a2 2 0 0 1-.864.51l-3.189.91a.75.75 0 0 1-.927-.927l.91-3.189a2 2 0 0 1 .51-.864zm1.768 1.06a.5.5 0 0 0-.708 0l-.585.586L13.5 3.94l.586-.586a.5.5 0 0 0 0-.708zM12.439 5 11 3.56 7.51 7.052a.5.5 0 0 0-.128.216l-.54 1.891 1.89-.54a.5.5 0 0 0 .217-.127zM3 2.501a.5.5 0 0 0-.5.5v10a.5.5 0 0 0 .5.5h10a.5.5 0 0 0 .5-.5V10H15v3.001a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-10a2 2 0 0 1 2-2h3v1.5z" clip-rule="evenodd"></path>
                </svg>
                <h6 class="text-xs font-semibold">Fecha reunión</h6>
              </button>
            }
          </div>
          <section class="flex relative items-center gap-x-[1lh]">
            @if (!sprint.prioritizationTechnique || sprint.risks.length === 0 ) {
              <div (click)="$event.stopPropagation()" class="flex flex-col w-fit text-xs items-center justify-center">
                <button class="flex justify-end items-center gap-x-2 peer/tech group w-43 min-w-fit text-left px-4 py-2 border rounded
                 bg-white text-main-black border-complementary-purple shadow-sm hover:bg-white-letter/40 focus:outline-none">
                    <span>Técnica: {{sprint.prioritizationTechnique === 'quantitative' ? 'Cuantitativa' : sprint.prioritizationTechnique === 'qualitative' ? 'Cualitativa' : 'Selecciona una técnica'}} </span>
                    <svg class="size-3 transition-transform duration-300 -rotate-90 group-focus:rotate-0" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="#6B7280">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 9-7 7-7-7"/>
                    </svg>
                </button>
                <ul (click)="$event.stopPropagation()" class="hidden z-[10] peer-focus/tech:absolute top-9 right-10 overflow-hidden peer-focus/tech:block w-fit bg-white border border-gray-300 rounded shadow-md mt-px py-1">
                  <li (mousedown)="changePrioritizationTechnique(sprint, 'quantitative', $event)"
                    class="px-4 py-2 hover:bg-complementary-purple/80 hover:text-white cursor-pointer">Cuantitativa</li>
                  <li (mousedown)="changePrioritizationTechnique(sprint, 'qualitative', $event)"
                    class="px-4 py-2 hover:bg-complementary-purple/80 hover:text-white cursor-pointer">Cualitativa</li>
                </ul>
              </div>
            } @else {
              <div (click)="$event.stopPropagation()" class="cursor-text w-43 text-xs text-center px-4 py-2 border rounded
              bg-white/40 text-main-black border-complementary-purple shadow-sm focus:outline-none">
                  <span>Técnica: {{sprint.prioritizationTechnique === 'quantitative' ? 'Cuantitativa' : 'Cualitativa'}} </span>
              </div>
            }
            <svg [class]="'transform ' + (openSprintIndex === sprint.sprint ? 'rotate-180' : 'rotate-0')
                  " width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg"
              class="transition-all duration-500 ease-in-out">
              <path d="m4.5 7.2 3.793 3.793a1 1 0 0 0 1.414 0L13.5 7.2" stroke="#1D293D" strokeWidth="1.5"
                strokeLinecap="round" strokeLinejoin="round" />
            </svg>
          </section>
        </div>
        <div [class]=" 'w-full flex flex-col gap-y-2 transition-all duration-500 ease-in-out -translate-y-2 max-h-0 opacity-0' +
          (openSprintIndex === sprint.sprint ? ' opacity-100 max-h-fit translate-y-0 pt-4 ' : '')">

            @if (openSprintIndex === sprint.sprint) {
              @for (risk of sprint.risks; track $index) {
                <app-risk-project-detail class="flex justify-center" [sprint]="sprint" [risk]="risk"
                (updatedRisk)="updateRisk($event)" (deleteRisk)="deleteRisk($event)" />
              }@empty {
            <div class="self-center w-8/10 sm:w-6/10 md:w-4/10 lg:w-4/10 p-px shadow-2xl rounded-2xl bg-gradient-to-r
              from-complementary-purple to-secondary-blue mb-[1lh]">
              <div class="flex flex-col items-center justify-center text-center p-[1lh]  rounded-[15px] bg-gradient-to-r
                    from-[#F3EAFF] to-[#E1EFFF]">
                <h2 class="text-2xl md:text-3xl font-medium">
                  ¡Añade los
                  <span
                    class="bg-gradient-to-r from-complementary-purple to-secondary-blue bg-clip-text text-transparent">Riesgos
                  </span>
                  del <span class="text-secondary-blue">Sprint!</span>
                </h2>
                <p class="text-slate-500 mt-2 max-w-lg max-md:text-sm">
                  Identifica los riesgos y con gamificación haz que mitigar riesgos sea divertido
                  y efectivo.
                </p>
                <footer class="inline-flex justify-center mt-4 items-center gap-3">
                  <button (click)="goToTaxonomy(sprint)" type="button" class="btn-secondary py-1.5 px-4">
                    Añade los riesgos
                  </button>
                  <img class="size-6" src="logo.png" alt="">
                </footer>
              </div>
            </div>
            }
            }
        </div>
      </section>
      }
    </section>
    }
  </section>
</main>
@if (showAddMembersModal) {

}
@if (openDatepicker.show) {
  <app-datepicker
    (close)="openDatepicker.show = false"
    (dateUpload)="saveDate($event)"
  />
}
@if (toast.show) {
<app-toast [title]="toast.title" [message]="toast.message" [type]="toast.type" [timeout]="toast.timeout!"
  (confirmed)="acceptedGoToPrioritization($event)" (stopShowing)="toast.show = false" />
}
